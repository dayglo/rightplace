# Implementation Plan: Schedule System (Backend)

## Executive Summary

Implement the Schedule System backend to enable schedule-aware roll call generation. The system tracks prisoner schedules (work, healthcare, legal visits, etc.) and integrates with the existing RollCallGeneratorService.

**Status:** Partially complete - migration, models, and repository exist but lack tests. Service and API layers need implementation.

**Estimated effort:** 2-3 days (6-8 work sessions)

## Current State Analysis

### ‚úÖ Already Implemented
- **Migration 004** (`server/app/db/migrations/004_schedule_entries.sql`) - Complete schema
- **Schedule Models** (`server/app/models/schedule.py`) - All Pydantic models including:
  - `ActivityType` enum (13 activity types)
  - `ScheduleEntry`, `ScheduleEntryCreate`, `ScheduleEntryUpdate`
  - `ScheduleQuery`, `ScheduleSyncBatch`
- **Schedule Repository** (`server/app/db/repositories/schedule_repo.py`) - Full CRUD including:
  - `create()`, `get_by_id()`, `get_by_inmate()`, `get_by_location()`
  - `get_at_time()` - critical for schedule-aware roll calls
  - `update()`, `delete()`, pagination methods

### ‚ùå Missing Components
- **No tests** - Zero test coverage for existing schedule code
- **Schedule Service** - Business logic layer doesn't exist
- **Schedule API** - REST endpoints don't exist
- **Integration** - Service and API not wired into FastAPI app

### üîó Dependencies
- `RollCallGeneratorService` already expects `ScheduleRepository` (line 34, 77)
- Repository interface matches what generator service needs
- No blocking dependencies for implementation

## Implementation Strategy

Following **strict TDD** as per `.clinerules/tdd-iteration-loop.md`:

1. **RED** - Write failing tests first
2. **GREEN** - Implement minimal code to pass
3. **REFACTOR** - Improve while keeping tests green
4. Commit only when all tests pass

## Detailed Implementation Plan

### Phase 1: Schedule Model Tests ‚úì (Models exist, add validation tests)

**Objective:** Verify existing Pydantic models work correctly

**Files to create:**
- `server/tests/unit/test_schedule_models.py`

**Test cases (8-10 tests):**
```python
class TestActivityType:
    def test_all_activity_types_defined():
        """Should have 13 activity types."""

class TestScheduleEntry:
    def test_valid_schedule_entry():
        """Should create valid schedule entry with all fields."""

    def test_time_format_validation():
        """Should enforce HH:MM time format."""

    def test_end_time_after_start_time():
        """Should reject end_time before or equal to start_time."""

    def test_day_of_week_range():
        """Should enforce day_of_week 0-6."""

class TestScheduleEntryCreate:
    def test_create_with_minimal_fields():
        """Should create with required fields only."""

    def test_create_with_optional_effective_date():
        """Should accept effective_date for one-off appointments."""

class TestScheduleEntryUpdate:
    def test_all_fields_optional():
        """Should allow partial updates."""
```

**Expected outcome:** All model validation tests pass

**Time estimate:** 1-2 hours

---

### Phase 2: Schedule Repository Tests

**Objective:** Test all repository methods with real SQLite database

**Files to create:**
- `server/tests/unit/test_schedule_repo.py`

**Test cases (15-18 tests):**
```python
class TestScheduleRepository:
    def test_create_schedule_entry():
        """Should create entry and return with generated ID."""

    def test_get_by_id_found():
        """Should retrieve entry by ID."""

    def test_get_by_id_not_found():
        """Should return None for unknown ID."""

    def test_get_by_inmate():
        """Should get all entries for inmate sorted by day/time."""

    def test_get_by_location():
        """Should get all entries for location."""

    def test_get_by_location_with_day_filter():
        """Should filter by day_of_week."""

    def test_get_at_time_matches_active_entries():
        """Should find entries where start <= time < end."""

    def test_get_at_time_with_location_filter():
        """Should combine time and location filters."""

    def test_get_at_time_excludes_wrong_day():
        """Should not match entries on different day."""

    def test_update_schedule_entry():
        """Should update specified fields only."""

    def test_update_nonexistent_entry():
        """Should return None for unknown ID."""

    def test_delete_schedule_entry():
        """Should delete and return True."""

    def test_delete_nonexistent_entry():
        """Should return False for unknown ID."""

    def test_delete_by_source():
        """Should delete all entries from source."""

    def test_list_all_with_pagination():
        """Should paginate results."""

    def test_count():
        """Should count total entries."""

    def test_foreign_key_constraint_inmate():
        """Should enforce FK to inmates table."""

    def test_foreign_key_constraint_location():
        """Should enforce FK to locations table."""
```

**Fixtures needed:**
```python
@pytest.fixture
def schedule_repo(test_db):
    """Provide ScheduleRepository with test database."""
    return ScheduleRepository(test_db)

@pytest.fixture
def sample_inmate(test_db):
    """Create test inmate for FK relationships."""

@pytest.fixture
def sample_location(test_db):
    """Create test location for FK relationships."""
```

**Expected outcome:**
- All repository methods tested
- 100% coverage of `schedule_repo.py`
- Foreign key constraints verified

**Time estimate:** 3-4 hours

---

### Phase 3: Schedule Service Implementation (TDD)

**Objective:** Build business logic layer with conflict detection

**Files to create:**
- `server/app/services/schedule_service.py`
- `server/tests/unit/test_schedule_service.py`

**Service responsibilities:**
1. Validate inmate/location existence before creating entries
2. Detect scheduling conflicts (same inmate, same time, different location)
3. Provide conflict-aware CRUD operations
4. Query helpers for common use cases

**Test cases (12-15 tests):**
```python
class TestScheduleService:
    def test_create_schedule_entry_success():
        """Should create entry when no conflicts."""

    def test_create_schedule_entry_validates_inmate_exists():
        """Should raise ValueError for unknown inmate."""

    def test_create_schedule_entry_validates_location_exists():
        """Should raise ValueError for unknown location."""

    def test_create_detects_time_conflict():
        """Should raise ValueError when inmate has overlapping entry."""

    def test_create_allows_different_days_same_time():
        """Should allow same time on different days."""

    def test_create_allows_same_location_different_times():
        """Should allow same location at different times."""

    def test_get_inmate_schedule():
        """Should return full week schedule for inmate."""

    def test_get_location_schedule():
        """Should return all activities at location."""

    def test_update_schedule_entry_success():
        """Should update entry when no new conflicts."""

    def test_update_schedule_entry_detects_conflict():
        """Should prevent update that creates conflict."""

    def test_update_schedule_entry_validates_entry_exists():
        """Should raise ValueError for unknown entry ID."""

    def test_delete_schedule_entry():
        """Should delete entry successfully."""

    def test_get_active_at_time():
        """Should find entries active at specific time."""
```

**Implementation pattern (service layer):**
```python
class ScheduleService:
    """Service for schedule entry business logic."""

    def __init__(
        self,
        schedule_repo: ScheduleRepository,
        inmate_repo: InmateRepository,
        location_repo: LocationRepository,
    ):
        self.schedule_repo = schedule_repo
        self.inmate_repo = inmate_repo
        self.location_repo = location_repo

    def create_schedule_entry(
        self, entry: ScheduleEntryCreate
    ) -> ScheduleEntry:
        """
        Create schedule entry with validation.

        Raises:
            ValueError: If inmate/location not found or time conflict
        """
        # Validate inmate exists
        inmate = self.inmate_repo.get_by_id(entry.inmate_id)
        if not inmate:
            raise ValueError(f"Inmate {entry.inmate_id} not found")

        # Validate location exists
        location = self.location_repo.get_by_id(entry.location_id)
        if not location:
            raise ValueError(f"Location {entry.location_id} not found")

        # Check for conflicts
        conflicts = self._find_conflicts(
            entry.inmate_id,
            entry.day_of_week,
            entry.start_time,
            entry.end_time,
            exclude_id=None,
        )
        if conflicts:
            raise ValueError(
                f"Schedule conflict: inmate already scheduled "
                f"{conflicts[0].start_time}-{conflicts[0].end_time} "
                f"at {conflicts[0].location_id}"
            )

        return self.schedule_repo.create(entry)

    def _find_conflicts(
        self,
        inmate_id: str,
        day: int,
        start: str,
        end: str,
        exclude_id: str | None,
    ) -> list[ScheduleEntry]:
        """Find overlapping schedule entries for inmate."""
        # Get all entries for inmate on this day
        all_entries = self.schedule_repo.get_by_inmate(inmate_id)
        day_entries = [e for e in all_entries if e.day_of_week == day]

        # Filter out the entry being updated
        if exclude_id:
            day_entries = [e for e in day_entries if e.id != exclude_id]

        # Check for time overlaps
        conflicts = []
        for entry in day_entries:
            # Times overlap if:
            # new_start < existing_end AND new_end > existing_start
            if start < entry.end_time and end > entry.start_time:
                conflicts.append(entry)

        return conflicts
```

**Expected outcome:**
- All service tests pass
- 100% coverage of `schedule_service.py`
- Conflict detection working correctly

**Time estimate:** 4-5 hours

---

### Phase 4: Schedule API Endpoints (TDD)

**Objective:** Expose schedule functionality via REST API

**Files to create:**
- `server/app/api/routes/schedules.py`
- `server/tests/integration/test_schedule_api.py`

**Endpoints to implement:**
```python
POST   /api/v1/schedules              # Create entry
GET    /api/v1/schedules/{id}         # Get by ID
PUT    /api/v1/schedules/{id}         # Update entry
DELETE /api/v1/schedules/{id}         # Delete entry
GET    /api/v1/schedules/inmate/{id}  # Get inmate schedule
GET    /api/v1/schedules/location/{id} # Get location schedule
GET    /api/v1/schedules              # List with pagination
POST   /api/v1/schedules/sync         # Bulk sync (future)
```

**Test cases (15-18 integration tests):**
```python
class TestScheduleAPI:
    def test_create_schedule_entry_success():
        """Should return 201 with created entry."""

    def test_create_schedule_entry_invalid_inmate():
        """Should return 400 for unknown inmate."""

    def test_create_schedule_entry_invalid_location():
        """Should return 400 for unknown location."""

    def test_create_schedule_entry_conflict():
        """Should return 409 for scheduling conflict."""

    def test_create_schedule_entry_validation_error():
        """Should return 422 for invalid data (bad time format, etc.)."""

    def test_get_schedule_entry_success():
        """Should return 200 with entry."""

    def test_get_schedule_entry_not_found():
        """Should return 404."""

    def test_update_schedule_entry_success():
        """Should return 200 with updated entry."""

    def test_update_schedule_entry_not_found():
        """Should return 404."""

    def test_update_schedule_entry_conflict():
        """Should return 409 for conflict."""

    def test_delete_schedule_entry_success():
        """Should return 204."""

    def test_delete_schedule_entry_not_found():
        """Should return 404."""

    def test_list_inmate_schedules():
        """Should return 200 with all entries for inmate."""

    def test_list_location_schedules():
        """Should return 200 with all entries for location."""

    def test_list_schedules_paginated():
        """Should paginate results with limit/offset."""
```

**Implementation pattern (API routes):**
```python
from fastapi import APIRouter, HTTPException, Depends, status

router = APIRouter()


def get_schedule_service(db=Depends(get_db)) -> ScheduleService:
    """Dependency injection for ScheduleService."""
    schedule_repo = ScheduleRepository(db)
    inmate_repo = InmateRepository(db)
    location_repo = LocationRepository(db)
    return ScheduleService(schedule_repo, inmate_repo, location_repo)


@router.post("/schedules", response_model=ScheduleEntry, status_code=201)
async def create_schedule_entry(
    entry: ScheduleEntryCreate,
    service: ScheduleService = Depends(get_schedule_service),
):
    """Create a new schedule entry."""
    try:
        return service.create_schedule_entry(entry)
    except ValueError as e:
        if "not found" in str(e):
            raise HTTPException(status_code=400, detail=str(e))
        elif "conflict" in str(e):
            raise HTTPException(status_code=409, detail=str(e))
        raise


@router.get("/schedules/{entry_id}", response_model=ScheduleEntry)
async def get_schedule_entry(
    entry_id: str,
    service: ScheduleService = Depends(get_schedule_service),
):
    """Get schedule entry by ID."""
    entry = service.schedule_repo.get_by_id(entry_id)
    if not entry:
        raise HTTPException(
            status_code=404, detail=f"Schedule entry {entry_id} not found"
        )
    return entry


@router.put("/schedules/{entry_id}", response_model=ScheduleEntry)
async def update_schedule_entry(
    entry_id: str,
    update: ScheduleEntryUpdate,
    service: ScheduleService = Depends(get_schedule_service),
):
    """Update schedule entry."""
    try:
        updated = service.update_schedule_entry(entry_id, update)
        if not updated:
            raise HTTPException(
                status_code=404, detail=f"Schedule entry {entry_id} not found"
            )
        return updated
    except ValueError as e:
        if "conflict" in str(e):
            raise HTTPException(status_code=409, detail=str(e))
        raise


@router.delete("/schedules/{entry_id}", status_code=204)
async def delete_schedule_entry(
    entry_id: str,
    service: ScheduleService = Depends(get_schedule_service),
):
    """Delete schedule entry."""
    success = service.delete_schedule_entry(entry_id)
    if not success:
        raise HTTPException(
            status_code=404, detail=f"Schedule entry {entry_id} not found"
        )


@router.get("/schedules/inmate/{inmate_id}", response_model=list[ScheduleEntry])
async def get_inmate_schedules(
    inmate_id: str,
    service: ScheduleService = Depends(get_schedule_service),
):
    """Get all schedule entries for an inmate."""
    return service.get_inmate_schedule(inmate_id)


@router.get("/schedules/location/{location_id}", response_model=list[ScheduleEntry])
async def get_location_schedules(
    location_id: str,
    day_of_week: int | None = None,
    service: ScheduleService = Depends(get_schedule_service),
):
    """Get all schedule entries for a location."""
    return service.get_location_schedule(location_id, day_of_week)
```

**Router registration:**
Update `server/app/main.py`:
```python
from app.api.routes import schedules

app.include_router(schedules.router, prefix="/api/v1", tags=["schedules"])
```

**Expected outcome:**
- All API integration tests pass
- Proper HTTP status codes (201, 200, 204, 400, 404, 409, 422)
- Error messages are descriptive
- Swagger docs updated automatically

**Time estimate:** 4-5 hours

---

### Phase 5: Integration with RollCallGeneratorService

**Objective:** Verify schedule system integrates correctly

**Files to test:**
- `server/tests/integration/test_rollcall_generator_with_schedules.py`

**Test cases (5-7 tests):**
```python
class TestRollCallGeneratorIntegration:
    def test_generate_uses_schedule_for_prisoner_count():
        """Should count prisoners based on schedule at roll call time."""

    def test_generate_excludes_prisoners_scheduled_elsewhere():
        """Should not count prisoners at work/healthcare/etc."""

    def test_get_expected_prisoners_includes_schedule_info():
        """Should include current activity and next appointment."""

    def test_priority_score_urgent_appointment():
        """Should prioritize prisoners with imminent appointments."""

    def test_priority_score_healthcare_bonus():
        """Should add extra priority for healthcare appointments."""
```

**Expected outcome:**
- RollCallGeneratorService works with real ScheduleRepository
- Expected prisoner counts accurate based on schedules
- Priority scoring works correctly

**Time estimate:** 2-3 hours

---

## Summary of Work Items

### Files to Create (7 new files)
1. `server/tests/unit/test_schedule_models.py` (8-10 tests)
2. `server/tests/unit/test_schedule_repo.py` (15-18 tests)
3. `server/tests/unit/test_schedule_service.py` (12-15 tests)
4. `server/app/services/schedule_service.py` (~200 lines)
5. `server/tests/integration/test_schedule_api.py` (15-18 tests)
6. `server/app/api/routes/schedules.py` (~150 lines)
7. `server/tests/integration/test_rollcall_generator_with_schedules.py` (5-7 tests)

### Files to Modify (1 file)
1. `server/app/main.py` - Add schedules router registration

### Total Test Count
- **Model tests:** 8-10
- **Repository tests:** 15-18
- **Service tests:** 12-15
- **API tests:** 15-18
- **Integration tests:** 5-7
- **TOTAL:** ~60-70 tests

### Test Coverage Goals
- `schedule_repo.py`: 100% (already exists)
- `schedule_service.py`: 100% (new)
- `schedules.py` (routes): 95%+ (new)
- Overall schedule system: 95%+

## Acceptance Criteria

‚úÖ All criteria from original prompt:
1. ‚úÖ All models pass validation tests
2. ‚úÖ Database migration runs successfully (already exists)
3. ‚úÖ Repository has 100% test coverage (15+ tests)
4. ‚úÖ Service has conflict detection tests
5. ‚úÖ API endpoints return correct status codes
6. ‚úÖ All integration tests pass
7. ‚úÖ ScheduleRepository is compatible with RollCallGeneratorService expectations

## TDD Workflow for Each Phase

Following `.clinerules/tdd-iteration-loop.md`:

```
1. üìù RED Phase
   - Write failing test
   - Run test ‚Üí see it fail
   - Verify failure message is expected

2. üü¢ GREEN Phase
   - Write minimal code to pass
   - Run test ‚Üí see it pass
   - No refactoring yet

3. üîµ REFACTOR Phase
   - Improve code quality
   - Keep tests passing
   - Run full suite

4. ‚úÖ COMMIT Phase
   - Commit when all tests pass
   - Clear, descriptive message
```

## Progress Tracking

Update `PROJECT_TODO.md` checkboxes as work completes:

```markdown
#### 5.1 Schedule Data Model
- [x] üìã Schedule models designed
- [x] üèóÔ∏è Migration 004 created
- [x] üß™ Model validation tests created
- [x] ‚úÖ All tests pass

#### 5.2 Schedule Repository
- [x] üìã ScheduleRepository interface designed
- [x] üèóÔ∏è ScheduleRepository built
- [x] üß™ Repository tests created (CRUD, queries)
- [x] ‚úÖ All tests pass

#### 5.3 Schedule Service
- [x] üìã ScheduleService designed
- [x] üèóÔ∏è ScheduleService built
- [x] üß™ Service tests created (business logic, conflict detection)
- [x] ‚úÖ All tests pass

#### 5.4 Schedule API Endpoints
- [x] üìã Schedule CRUD APIs designed
- [x] üèóÔ∏è Schedule endpoints built
- [x] üß™ Schedule API integration tests created
- [x] ‚úÖ All tests pass
```

## Risk Mitigation

### Potential Issues

**1. Time overlap logic complexity**
- Mitigation: Thoroughly test edge cases (same start, same end, adjacent times)
- Add helper method `_times_overlap()` with clear documentation

**2. Conflict detection performance**
- Mitigation: Query optimization with indexes (already in migration)
- Consider caching if > 1000 entries per inmate

**3. Foreign key violations in tests**
- Mitigation: Use proper fixtures to create inmates/locations first
- Clean up test database between tests

**4. Timezone handling**
- Mitigation: Use UTC consistently (repository already does)
- Document that times are in facility local timezone (no TZ in HH:MM)

## Next Steps After Completion

Once schedule system is complete:

1. **Demo data generator** (Phase 5.6)
   - Generate realistic 2-week schedules
   - 1600 prisoners
   - Weekday/weekend patterns
   - Individual variations

2. **Web UI integration**
   - Schedule management page
   - Visual timeline view
   - Conflict warnings

3. **Schedule sync endpoint**
   - Bulk import from external systems
   - Handle updates/deletes

## References

- Design Doc: `prison-rollcall-design-document-v3.md` (lines 888-941, 1150-1171)
- Existing patterns:
  - Repository: `app/db/repositories/inmate_repo.py`
  - Service: `app/services/rollcall_service.py`
  - API: `app/api/routes/inmates.py`
- Consumer: `app/services/rollcall_generator_service.py` (line 34, 77, 162)

---

**Plan Author:** Claude Code
**Plan Date:** 2026-01-29
**Plan Version:** 1.0
**Estimated Total Time:** 16-20 hours (2-3 days)
